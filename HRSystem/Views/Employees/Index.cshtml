@using HR.PresentationModels.Dto.Employees
@model EmployeeDto

@{
	ViewData["Title"] = "Index";
}
<ul class="nav nav-tabs nav-line-tabs mb-5 fs-6">
	<li class="nav-item">
		<a class="nav-link active" data-bs-toggle="tab" href="#kt_tab_pane_1">Employees</a>
	</li>
	@if (User.IsInRole("Admin"))
						{
	<li class="nav-item">
		<a class="nav-link" data-bs-toggle="tab" href="#kt_tab_pane_2">Managers</a>
	</li>
						}
	
</ul>

<div class="tab-content" id="myTabContent">
	<div class="tab-pane fade show active" id="kt_tab_pane_1" role="tabpanel">
		<div class="card">
			<!--begin::Card header-->
			<div class="card-header border-0 pt-6">
				<!--begin::Card title-->
				<div class="card-title">
					<!--begin::Search-->
					<div class="d-flex align-items-center position-relative my-1">
						<!--begin::Svg Icon | path: icons/duotune/general/gen021.svg-->
						<!--end::Svg Icon-->
					</div>
					<!--end::Search-->
				</div>
				<!--begin::Card title-->
				<!--begin::Card toolbar-->
				<div class="card-toolbar">
					<!--begin::Toolbar-->
					<div class="d-flex justify-content-end" data-kt-user-table-toolbar="base">

						<!--begin::Menu 1-->
						<div class="menu menu-sub menu-sub-dropdown w-300px w-md-325px" data-kt-menu="true">
							<!--begin::Header-->
							<!--end::Header-->
							<!--begin::Separator-->
							<div class="separator border-gray-200"></div>
							<!--end::Separator-->
							<!--begin::Content-->
							<!--end::Content-->
						</div>
						<!--end::Menu 1-->
						<!--end::Filter-->
						<!--end::Export-->
						<!--begin::Add user-->
						@if (User.IsInRole("Admin"))
						{
							<button type="button" id="Modal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#empModal" onclick="Create()">
								<!--begin::Svg Icon | path: icons/duotune/arrows/arr075.svg-->
								<span class="svg-icon svg-icon-2">
									<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
										<rect opacity="0.5" x="11.364" y="20.364" width="16" height="2" rx="1" transform="rotate(-90 11.364 20.364)" fill="black"></rect>
										<rect x="4.36396" y="11.364" width="16" height="2" rx="1" fill="black"></rect>
									</svg>
								</span>
								<!--end::Svg Icon-->Add Employee
						</button>
						}
						<!--end::Add user-->
					</div>
					<!--end::Toolbar-->
					<!--begin::Group actions-->
					<!--end::Group actions-->
					<!--end::Modal - New Card-->
					<!--begin::Modal - Add task-->
					<div class="modal fade" id="empModal" tabindex="-1" aria-hidden="true">
						<!--begin::Modal dialog-->
						<div class="modal-dialog modal-dialog-centered mw-650px">
							<!--begin::Modal content-->
							<div class="modal-content">
								<!--begin::Modal header-->
								<div class="modal-header" id="kt_modal_add_user_header">
									<!--begin::Modal title-->
									<h2 id="modalTitle" class="fw-bolder"></h2>
									<!--end::Modal title-->
									<!--begin::Close-->
									<div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
										<!--begin::Svg Icon | path: icons/duotune/arrows/arr061.svg-->
										<span class="svg-icon svg-icon-1">
											<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
												<rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="black"></rect>
												<rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="black"></rect>
											</svg>
										</span>
										<!--end::Svg Icon-->
									</div>
									<!--end::Close-->
								</div>
								<!--end::Modal header-->
								<!--begin::Modal body-->
								<div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
									<!--begin::Form-->
									<form id="EmpForm" class="form fv-plugins-bootstrap5 fv-plugins-framework" method="post" enctype="multipart/form-data">
										<!--begin::Scroll-->
										<input type="hidden" asp-for="ID">

										<div class="d-flex flex-column scroll-y me-n7 pe-7" id="kt_modal_add_user_scroll" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto" data-kt-scroll-dependencies="#kt_modal_add_user_header" data-kt-scroll-wrappers="#kt_modal_add_user_scroll" data-kt-scroll-offset="300px" style="max-height: 629px;">
											<!--begin::Input group-->
											<!--end::Input group-->
											<!--begin::Input group-->
											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="required fw-bold fs-6 mb-2">Name</label>
												<!--end::Label-->
												<!--begin::Input-->
												<input type="text" asp-for="Name" class="form-control form-control-solid mb-3 mb-lg-0">
												<!--end::Input-->
												<span asp-validation-for="Name" class="fv-plugins-message-container invalid-feedback"></span>
											</div>
											<!--end::Input group-->
											<!--begin::Input group-->
											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="required fw-bold fs-6 mb-2">Address</label>
												<!--end::Label-->
												<!--begin::Input-->
												<input type="text" asp-for="Address" class="form-control form-control-solid mb-3 mb-lg-0">
												<!--end::Input-->
												<span asp-validation-for="Address" class="fv-plugins-message-container invalid-feedback"></span>
											</div>

											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="required fw-bold fs-6 mb-2">BirthDate</label>
												<!--end::Label-->
												<!--begin::Input-->
												<input type="date" asp-for="BirthDate" class="form-control form-control-solid mb-3 mb-lg-0">
												<!--end::Input-->
												<span asp-validation-for="BirthDate" class="fv-plugins-message-container invalid-feedback"></span>
											</div>

											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="required fw-bold fs-6 mb-2">EmailAddress</label>
												<!--end::Label-->
												<!--begin::Input-->
												<input type="email" asp-for="EmailAddress" class="form-control form-control-solid mb-3 mb-lg-0">
												<!--end::Input-->
												<span asp-validation-for="EmailAddress" class="fv-plugins-message-container invalid-feedback"></span>
											</div>
											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="required fw-bold fs-6 mb-2">Password</label>
												<!--end::Label-->
												<!--begin::Input-->
												<input type="password" asp-for="Password" class="form-control form-control-solid mb-3 mb-lg-0">
												<!--end::Input-->
												<span asp-validation-for="Password" class="fv-plugins-message-container invalid-feedback"></span>
											</div>
											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="required fw-bold fs-6 mb-2">Mobile</label>
												<!--end::Label-->
												<!--begin::Input-->
												<input type="text" asp-for="Mobile" class="form-control form-control-solid mb-3 mb-lg-0">
												<!--end::Input-->
												<span asp-validation-for="Mobile" class="fv-plugins-message-container invalid-feedback"></span>
											</div>
											<div class="fv-row mb-7 fv-plugins-icon-container">
												<!--begin::Label-->
												<label class="fw-bold fs-6 mb-2">Manager</label>
												<!--end::Label-->
												<!--begin::Input-->
												<select asp-for="Manager_id" asp-items="ViewBag.managers" class="form-control form-control-solid mb-3 mb-lg-0">
													<option value="">Choose</option>
												</select>
												<!--end::Input-->
												<span asp-validation-for="Manager_id" class="fv-plugins-message-container invalid-feedback"></span>
											</div>

										</div>
										<!--end::Scroll-->
										<!--begin::Actions-->
										<div class="text-center pt-15">
											<button type="reset" class="btn btn-light me-3" data-bs-dismiss="modal">Discard</button>
											<button type="submit" class="btn btn-primary" data-kt-users-modal-action="Save">
												<span class="indicator-label">Save</span>
												<span class="indicator-progress">
													Please wait...
													<span class="spinner-border spinner-border-sm align-middle ms-2"></span>
												</span>
											</button>
										</div>
										<!--end::Actions-->
										<div></div>
									</form>
									<!--end::Form-->
								</div>
								<!--end::Modal body-->
							</div>
							<!--end::Modal content-->
						</div>
						<!--end::Modal dialog-->
					</div>
					<!--end::Modal - Add task-->
				</div>
				<!--end::Card toolbar-->
			</div>
			<!--end::Card header-->
			<!--begin::Card body-->
			<div class="card-body pt-0">
				<!--begin::Table-->
				<div id="kt_table_users_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
					<div class="table-responsive">
						<table class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer" id="Employees_Table">
							<!--begin::Table head-->
							<thead>
								<!--begin::Table row-->
								<tr class="text-start text-muted fw-bolder fs-7 text-uppercase gs-0">

									<th>#</th>
									<th>#</th>
									<th>Name</th>
									<th>Email</th>
									<th>Mobile</th>
									<th>BirthDate</th>
									<th>Address</th>
									<th>Manager</th>
									<th>Actions</th>
								</tr>
							</thead>

						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	@if (User.IsInRole("Admin"))
	{
		<div class="tab-pane fade" id="kt_tab_pane_2" role="tabpanel">
			<div class="card-body pt-0">
				<!--begin::Table-->
				<div id="kt_table_users_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
					<div class="table-responsive">
						<table class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer" id="Managers_Table">
							<!--begin::Table head-->
							<thead>
								<!--begin::Table row-->
								<tr class="text-start text-muted fw-bolder fs-7 text-uppercase gs-0">

									<th>#</th>
									<th>Name</th>
									<th>Email</th>
									<th>Mobile</th>
									<th>BirthDate</th>
									<th>Address</th>
									<th>Employees Count</th>
									<th>Actions</th>
								</tr>
							</thead>

						</table>
					</div>
				</div>
			</div>
		</div>
	}
</div>

<div class="modal" id="ModelDelete" role="dialog">
	<div class="modal-dialog modal-md">
		<div class="modal-content">
			<div class="modal-header">
				<h4>Delete</h4>
			</div>
			<div class="modal-body text-center" id="Delete">
				<h2>Are You Sure ?<span id="text"></span></h2>
			</div>
			<div class="modal-footer">
				<a href="#" class="btn btn-danger" id="DeleteConfirm">Delete</a>
				<a href="#" class="btn btn-primary" data-bs-dismiss="modal">Cancel</a>
			</div>
		</div>
	</div>
</div>
		@section Scripts {
	<partial name="_ValidationScriptsPartial" />

			<script src="~/assets/js/table.js"></script>
			<script src="~/assets/js/export-users.js"></script>
			<script src="~/assets/js/custom/modals/users-search.js"></script>
			<script>
		$.fn.clearValidation = function () { var v = $(this).validate(); $('[name]', this).each(function () { v.successList.push(this); v.showErrors(); }); v.resetForm(); v.reset(); };

		function format(d) {
			// `d` is the original data object for the row

			var res = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;width:100%">' +
				'<tr>' +
				'<td>Date</td>' +
				'<td>Type</td>' +
				'</tr>';
			
				for(var i=0;i<d.attendance.length;i++)
				
				{

				res += '<tr>' +
					'<td>' + new Date(d.attendance[i].date).toLocaleString() + '</td>' +
					'<td>' + d.attendance[i].message+ '</td>' +
					'</tr>';
					
				}

			res +='</table>'
	return res;
		}
				$(document).ready(function () {
	
				var table =	$('#Employees_Table').DataTable({
					"ajax": {
						 "processing": true,
						   "filter": true,
						'url': "@Url.Action("GetAll")",
						'type': "GET",
						"datatype": "json",
					    
					},
				dom: 'Blfrtip',
				buttons: [
					'copy', 'csv', 'excel', 'pdf', 'print'
				],
					"columns": [
						{
							"data": null, "render": function (data, type, full, meta) {
								return meta.row + 1;
							}
						},
					{
						className: 'dt-control',
						orderable: false,
						data: null,
						defaultContent: `<button class='btn btn-primary ED' style='margin:5px'>Attendance</button>`,
					},

						{ "data": "name" },
					{ "data": "emailAddress" },
					{ "data": "mobile" },
					{ "data": "birthDate" },
					{ "data": "address" },
					{ "data": "managerName" },
						{
							"data": "id", "render": function (data, type, row, meta) {
								return "<button class='btn btn-primary ED' style='margin:5px' onclick='Edit(" + data + ")'><i class='fas fa-highlighter'></i></button>"+
								`<button class='btn btn-danger ED' style='margin:5px' onclick="Delete(${data})"><i class='fas fa-trash-alt'></i></button>`
							}
						},
					
					],
				});
			$('#Employees_Table tbody').on('click', 'td.dt-control', function () {
				var tr = $(this).closest('tr');
				var row = table.row(tr);

				if (row.child.isShown()) {
					// This row is already open - close it
					row.child.hide();
					tr.removeClass('shown');
				} else {
					// Open this row
					row.child(format(row.data())).show();
					tr.addClass('shown');
				}
			});
			$("#DeleteConfirm").click(function () {
					$.ajax({
						type: "post",
						url:'@Url.Action("Delete")?id=' + DeleteID,
						success: function (response) {
							if (response == 1) {
								$("#ModelDelete").modal("hide");
							$("#Employees_Table").DataTable().ajax.reload();
							refreshManagers()

								 Swal.fire({
								  position: 'center',
								  icon: 'success',
								html: 'Delete Successful',
								  showConfirmButton: false,
								   timer: 1500
								 });
							}
							else {
								 Swal.fire({
								  position: 'center',
								  icon: 'error',
								  html: 'Error',
								  showConfirmButton: false,
								   timer: 1500
								 });
							}

						},
						error: function () {
							Swal.fire({
								  position: 'center',
								  icon: 'error',
								  html: 'Error',
								  showConfirmButton: false,
								  timer: 1500
								 });
						}
					});
				});

			});
		var DeleteID;

			function Delete(id) {
				$("#ModelDelete").modal('show');
				DeleteID = id;
			}



			function Create() {
			
				$("#EmpForm")[0].reset();
				$("#EmpForm").change();
				$("#EmpForm").clearValidation();
				$("#ID").val(0);
				$("#Password").prop("required",true);
				$("#modalTitle").html("Add Employee");
				$("#empModal").modal("show");
			}


		$("#EmpForm").submit(function (e) {
			e.preventDefault();
			if($("#EmpForm").valid())
			{
				if(new Date($("#BirthDate").val())>=new Date())
				{
					Swal.fire({
						position: 'center',
						icon: 'error',
						html: "BirthDate Should be bigger than today",
						timer: 1500
					});
					return 0;
				}
				if ($("#Manager_id").val() == $("#ID").val()) {
					Swal.fire({
						position: 'center',
						icon: 'error',
						html: "You can't be manager on yourself",
						timer: 1500
					});
					return 0;
				}
			
					var data = $("#EmpForm").serialize();
					$.ajax({
						type: "post",
						url: "@Url.Action("Save")",
						data: data,
						success: function (response) {
							if (response == 1) {
								$("#EmpForm")[0].reset();
								$("#ID").val(0);
								$("#Employees_Table").DataTable().ajax.reload();
								$("#Managers_Table").DataTable().ajax.reload();

						refreshManagers()
						$("#empModal").modal('hide');

								Swal.fire({
								  position: 'center',
								  icon: 'success',
							      html:"Save Successful",
								  timer: 1500
								 });

							}
							else {
								 Swal.fire({
								  position: 'center',
								  icon: 'error',
								  html: "Error",
								  timer: 1500
								 });

							}
							}
						
					});
					}

				
			});


			function Edit(EditedID) {
				var url= '@Url.Action("GetById")?id=' + EditedID;
				$.ajax({
					type: "GET",
					url: url,
					success: function (rs) {
						$("#modalTitle").html("Edit Employee");
                    $("#ID").val(rs.id)
                    $("#Name").val(rs.name);
					$("#Address").val(rs.address);
					$("#BirthDate").val(rs.birthDate.split('T')[0]);
					$("#EmailAddress").val(rs.emailAddress);
					$("#Mobile").val(rs.mobile);
					$("#Manager_id").val(rs.manager_id);
					$("#Password").prop("required", false);
					$("#EmpForm").clearValidation();

					$("#EmpForm").change();
					$("#empModal").modal('show');
                }
            });
        }
		


		function refreshManagers(){
			$.ajax({
				type: "GET",
				url: "@Url.Action("RefreshEmployees")",
				success: function (rs) {
					var s = '<option value="">Choose</option>';
					for (var i = 0; i < rs.data.length; i++) {
						s += '<option value="' + rs.data[i].value + '">' + rs.data[i].text + '</option>';
					}
					$("#Manager_id").html(s);
				}
			});
		}
		refreshManagers();
	</script>

	<script>
		function formatManager(d) {
			// `d` is the original data object for the row

			var res = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px; width:100%">' +
				'<tr>' +
					'<th>Name</th>'+
								'<th>Email</th>'+
								'<th>Mobile</th>'+
								'<th>BirthDate</th>'+
								'<th>Address</th>'+
				'</tr>';

			for (var i = 0; i < d.employees.length; i++) {

				res += '<tr>' +
									'<td>' + d.employees[i].name + '</td>' +
					'<td>' + d.employees[i].emailAddress + '</td>' +
					'<td>' + d.employees[i].mobile + '</td>' +
					'<td>' + d.employees[i].birthDate.split('T')[0]+ '</td>' +
					'<td>' + d.employees[i].address + '</td>' +
					'</tr>';

			}

			res += '</table>'
			return res;
		}
		$(document).ready(function () {

			var managersTable = $('#Managers_Table').DataTable({
				"ajax": {
					"processing": true,
					"filter": true,
					'url': "@Url.Action("GetAllManagers")",
					'type': "GET",
					"datatype": "json",

				},
				dom: 'Blfrtip',
				buttons: [
					'copy', 'csv', 'excel', 'pdf', 'print'
				],
				"columns": [
					{
						"data": null, "render": function (data, type, full, meta) {
							return meta.row + 1;
						}
					},
					

					{ "data": "name" },
					{ "data": "emailAddress" },
					{ "data": "mobile" },
					{ "data": "birthDate" },
					{ "data": "address" },
					{ "data": "count" },
					{
						className: 'dt-control',
						orderable: false,
						data: null,
						defaultContent: `<button class='btn btn-primary ED' style='margin:5px'>Employees</button>`,
					},

				],
			});
			$('#Managers_Table tbody').on('click', 'td.dt-control', function () {
				var tr = $(this).closest('tr');
				var row = managersTable.row(tr);

				if (row.child.isShown()) {
					// This row is already open - close it
					row.child.hide();
					tr.removeClass('shown');
				} else {
					// Open this row
					row.child(formatManager(row.data())).show();
					tr.addClass('shown');
				}
			});
		});
	</script>
	}
